<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>簿記1級クイズ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container" id="startScreen">
    <h1>簿記1級クイズ</h1>
    <button id="startButton" class="option-button">クイズを開始する</button>
  </div>

  <div class="container hidden" id="categoryScreen">
    <h2>カテゴリを選択してください</h2>
    <div id="categories"></div>
  </div>

  <div class="container hidden" id="quizScreen">
    <h2 id="questionText"></h2>
    <div id="answers"></div>
    <input type="text" id="writtenAnswer" class="hidden" placeholder="記述式の回答を入力してください">
    <button id="submitAnswerButton" class="option-button hidden">回答する</button>
    <button id="skipButton" class="option-button">スキップ</button>
    <button id="giveUpButton" class="option-button" style="background-color: red;">諦める</button>
  </div>

  <div class="container hidden" id="resultScreen">
    <h2>結果発表</h2>
    <div id="result"></div>
    <button id="restartButton" class="option-button">最初からやり直す</button>
  </div>

  <script>
    const dataUrl = "./quiz-data.json";

    let questions = [];
    let filteredQuestions = [];
    let currentQuestionIndex = 0;
    let playerAnswers = [];
    let skippedQuestions = [];

    async function fetchData() {
      try {
        const response = await fetch(dataUrl);
        if (!response.ok) throw new Error("データの取得に失敗しました。");
        questions = await response.json();
        showCategories();
      } catch (error) {
        console.error(error);
        alert("問題データを読み込めませんでした。");
      }
    }

    function showCategories() {
      const categories = [...new Set(questions.map(q => q.category))];
      const categoriesDiv = document.getElementById("categories");
      categoriesDiv.innerHTML = "";
      categories.forEach(category => {
        const button = document.createElement("button");
        button.textContent = category;
        button.classList.add("option-button");
        button.onclick = () => selectCategory(category);
        categoriesDiv.appendChild(button);
      });

      document.getElementById("startScreen").classList.add("hidden");
      document.getElementById("categoryScreen").classList.remove("hidden");
    }

    function selectCategory(category) {
      filteredQuestions = questions.filter(q => q.category === category);
      currentQuestionIndex = 0;
      skippedQuestions = [];
      playerAnswers = [];
      document.getElementById("categoryScreen").classList.add("hidden");
      document.getElementById("quizScreen").classList.remove("hidden");
      showQuestion();
    }

    function showQuestion() {
      if (currentQuestionIndex >= filteredQuestions.length) {
        if (skippedQuestions.length > 0) {
          filteredQuestions = skippedQuestions;
          skippedQuestions = [];
          currentQuestionIndex = 0;
        } else {
          showResult();
          return;
        }
      }

      const question = filteredQuestions[currentQuestionIndex];
      const questionText = document.getElementById("questionText");
      const answers = document.getElementById("answers");
      const writtenAnswer = document.getElementById("writtenAnswer");
      const submitAnswerButton = document.getElementById("submitAnswerButton");

      questionText.textContent = question.question;

      if (question.options) {
        // 選択式問題
        answers.innerHTML = "";
        writtenAnswer.classList.add("hidden");
        submitAnswerButton.classList.add("hidden");
        question.options.forEach((option, index) => {
          const button = document.createElement("button");
          button.textContent = option;
          button.classList.add("option-button");
          button.onclick = () => handleAnswer(index);
          answers.appendChild(button);
        });
      } else {
        // 記述式問題
        answers.innerHTML = "";
        writtenAnswer.classList.remove("hidden");
        submitAnswerButton.classList.remove("hidden");
        submitAnswerButton.onclick = () => handleAnswer(writtenAnswer.value.trim());
      }
    }

    function handleAnswer(selectedAnswer) {
      const question = filteredQuestions[currentQuestionIndex];
      const isCorrect = question.options
        ? selectedAnswer === question.answer
        : selectedAnswer.toString() === question.answer.toString();

      playerAnswers.push({
        question: question.question,
        selected: question.options ? question.options[selectedAnswer] : selectedAnswer,
        correct: question.options ? question.options[question.answer] : question.answer,
        explanation: question.explanation,
        isCorrect,
      });

      currentQuestionIndex++;
      showQuestion();
    }

    function skipQuestion() {
      skippedQuestions.push(filteredQuestions[currentQuestionIndex]);
      currentQuestionIndex++;
      showQuestion();
    }

    function giveUp() {
      for (let i = currentQuestionIndex; i < filteredQuestions.length; i++) {
        const question = filteredQuestions[i];
        playerAnswers.push({
          question: question.question,
          selected: "未回答",
          correct: question.options ? question.options[question.answer] : question.answer,
          explanation: question.explanation,
          isCorrect: false,
        });
      }
      showResult();
    }

    function showResult() {
      document.getElementById("quizScreen").classList.add("hidden");
      const resultScreen = document.getElementById("resultScreen");
      const resultDiv = document.getElementById("result");

      resultScreen.classList.remove("hidden");

      resultDiv.innerHTML = playerAnswers
        .map((answer, index) => `
          <div>
            <h3>問題 ${index + 1}</h3>
            <p><strong style="color: navy;">問題:</strong> ${answer.question}</p>
            <p><strong style="color: brown;">あなたの回答:</strong> ${answer.selected || "未回答"}</p>
            <p><strong style="color: green;">正解:</strong> ${answer.correct}</p>
            <p><strong style="color: gray;">解説:</strong> ${answer.explanation}</p>
            <p style="color: ${answer.isCorrect ? "green" : "red"};">
              ${answer.isCorrect ? "正解！" : "不正解！"}
            </p>
          </div>
        `)
        .join("");
    }

    document.getElementById("startButton").onclick = fetchData;
    document.getElementById("restartButton").onclick = () => {
      document.getElementById("resultScreen").classList.add("hidden");
      document.getElementById("startScreen").classList.remove("hidden");
    };
    document.getElementById("skipButton").onclick = skipQuestion;
    document.getElementById("giveUpButton").onclick = giveUp;
  </script>
</body>
</html>
